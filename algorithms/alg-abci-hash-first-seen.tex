% Hash ABCI - alg4
\begin{figure}[t!]
  \begin{adjustbox}{minipage=[t]{\columnwidth}}
    \begin{algorithm}[H]
      \renewcommand{\thealgorithm}{ABCI Hashchain}         
      \caption{\small First Seen Consolidation}%
      \label{alg:abci-hash-first-seen}%
      \small
      \begin{algorithmic}[1]
            \State \textbf{Init:} \texttt{epoch} $\leftarrow$ \textbf{0}, \texttt{history} $\leftarrow$ \{\}, \texttt{hashToOriginal} $\leftarrow$ \{\}, \texttt{hashToSignatures} $\leftarrow$ \{\}, \texttt{mBlocksHashes} $\leftarrow$ \{\}
      
            \Function{DeliverTx}{$transaction$}\label{alg4:deliver_tx}
            		\State \texttt{hash, signature} $\leftarrow$ $transaction$
            		\State \texttt{hashToSignatures}[\texttt{hash}] $\leftarrow$ \texttt{hashToSignatures}[\texttt{hash}] $\cup$  \texttt{signature}
            		\If {not (\texttt{hash} in \texttt{mBlocksHashes})}
					\State \texttt{mBlocksHashes}.Push(\texttt{hash}) 
            		\EndIf
            		\If {not \texttt{hashToOriginal}[ \texttt{hash}] \textbf{exists}}
            			\State \textbf{spawns} asyncRevertHash($transaction$)
                	\EndIf
                \State \textbf{return}
            \EndFunction
            
            \Function{EndBlock}{}
            		\State \texttt{hashesToDefine} $\leftarrow$ \texttt{mBlocksHashes}.Pop()
            		\For{\texttt{hash in hashesToDefine}}
            			\If {shouldConsolidateHash(\texttt{hash})}
            				\If {\texttt{hashToOriginal}[\texttt{hash}] \textbf{exists}} 				
            					\If {isValidBatch(\texttt{hashToOriginal}[\texttt{hash}])}
            				
            						\State elements $\leftarrow$ getElementsFromBatch(\texttt{hashToOriginal}[ \texttt{hash}])
            		
            						%\\Comment{A transaction may contain invalid elements. Only add the valid ones.}
            						\State addElements(\texttt{hash})
            					\EndIf
            				\Else
            					\Comment{Unusual but still a problem}
            				\EndIf
					\Else
						  \Comment{Discard hash}          			
            			\EndIf
            		\EndFor
            \EndFunction
            
        \end{algorithmic}
      \end{algorithm}
	\end{adjustbox}
  \end{figure}

