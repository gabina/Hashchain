% Alg 1
\begin{figure}[t!]
%  \begin{tikzpicture}
%    \node (tmp) at (0,0){%
  \begin{adjustbox}{minipage=[t]{\columnwidth}}
    \begin{algorithm}[H]
      \caption{\small Server $i$ implementation using DSO and BAB}%
      \label{DPO-alg1}%
      \small
      \begin{algorithmic}[1]
        % \setcounter{ALG@line}{2} % hardcoded :(
        %
                \State \textbf{Init:} $\<epoch> \leftarrow 0,\hspace{2em}\<history>\leftarrow\emptyset$\label{alg1:history}
%                \State \textbf{Init:} $\<history> \leftarrow \emptyset$\label{seq:history}
            \State \textbf{Init:} $\<theset> \leftarrow $\<DSO>.\<Init>\(()\)~\label{alg1:init_e}
%            \tikz{\node(tmp1){};}
            \Function{\<Get>}{~}
              \State \<return> $(\<theset>.\text{\<Get>}(), \<history>,\<epoch>)$~\label{alg1:func_get}
%              \tikz{\node(tmp2){};}
            \EndFunction
            %
            \Function{\<Add>}{$e$}
            \State \textbf{assert} {\(valid(e)\)}
            \State $\<theset>.{\<Add>}(e)$
            \EndFunction
            \setcounter{ALG@line}{11}
            \Function{\<EpochInc>}{$h$}\label{alg1:epoch_inc}
%              \tikz{\node(tmp3){};}
              % \State \Comment{Client request is assumed valid}
              \State \textbf{assert} $h \equiv \<epoch> + 1$
              % \State \(flattenHistory <- \{ e \mid e \in E \wedge \langle h , E \rangle \in \<history>\} \)
              % \State $proposal \leftarrow \<theset>.\<Get>() \setminus flattenHistory $~\label{alg1:proposal}
              \State $proposal \leftarrow
                \<theset>.\text{\<Get>}()
                \setminus \bigcup_{k=1}^{\<epoch>} \<history>(k)$~\label{alg1:proposal}
               % \bigcup_{\langle H, E \rangle \in \<history>}{E}$~\label{alg1:proposal}
              % Trying to fit it in the algorithm  1 \{ e : e \in E \wedge \langle h,E \rangle \in \HISTORY$
              \State \<BAB>.\<Broadcast>(\<mepochinc>($h, proposal, i$))\label{alg1:bcast_proposal}
              % \State \textbf{return ACK}
%              \State \<return> \<ack>
            \EndFunction
            \Upon{\<BAB>.\<Deliver>(\<mepochinc>($h, proposal,
                  j$))\\\hspace{2em} from $2f+1$ different servers $j$ for the same $h$}\label{alg1:upon_delivery} %{DPO-alg-delivery}
              \State \textbf{assert} $h \equiv \<epoch> + 1$
              % \State \textbf{wait} $2f+1$ BAB.Deliver of the same epoch $h$
              \State $E \leftarrow \{e:e \in \textit{proposal}$ % \\
              % \hspace{4em}
              for at least $f+1$ different j\}%$(h,proposal,j)\}$
              % \State $history \leftarrow history \cup \{\langle h, e\rangle\}$
              % \EndFor
              \State $\<history> \leftarrow \<history> \cup \{\langle h, E \rangle\}$\label{alg1:added}
              \State $\<epoch> \leftarrow \<epoch> + 1$
%              \tikz{\node(tmp4){};}
            \EndUpon
          \end{algorithmic}
        \end{algorithm}
        \end{adjustbox}
%    };
%        \path(tmp1-|tmp.west) -- +(1.2ex,0.5em)node(tmpa){};
%        \path(tmp2-|tmp.east) -- +(-0.5ex,-0.75em)node(tmpb){};
%        \draw[red, thick](tmpa) rectangle (tmpb);
%        \path(tmp3-|tmp.west) -- +(1.2ex,0.5em)node(tmpc){};
%        \path(tmp4-|tmp.east) -- +(-0.5ex,-2em)node(tmpd){};
%        \draw[red, thick](tmpc) rectangle (tmpd);
%      \end{tikzpicture}
  \end{figure}
